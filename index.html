<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LisboaGo - Seu T√°xi em Lisboa</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #map { height: 100vh; width: 100vw; }
        
        header {
            position: absolute; top: 0; left: 0; right: 0;
            background: #000; color: white; padding: 15px 20px;
            z-index: 1000; display: flex; justify-content: space-between;
            align-items: center;
        }
        
        .logo h1 { font-size: 24px; font-weight: 700; color: #FFD700; }
        
        .driver-area-btn {
            background: #FFD700; color: #000; border: none;
            padding: 10px 20px; border-radius: 5px; font-weight: 600;
            cursor: pointer;
        }
        
        .system-status {
            position: absolute; top: 10px; right: 10px;
            background: #ff9800; color: white; padding: 8px 12px;
            border-radius: 5px; font-size: 12px; z-index: 1000;
            font-weight: bold;
        }
        
        .status-online { background: #4caf50; }
        .status-offline { background: #ff9800; }
        .status-firebase { background: #2196f3; }
    </style>
</head>
<body>
    <div class="system-status status-firebase" id="system-status">üåê Conectando ao Firebase...</div>
    
    <header>
        <div class="logo">
            <h1>LisboaGo</h1>
            <p>Seu T√°xi Em Lisboa, Quando Precisar!</p>
        </div>
        <button class="driver-area-btn" id="driver-area-btn">√Årea do Motorista</button>
    </header>
    
    <div id="map"></div>

    <script>
        // =============================================
        // CONFIGURA√á√ÉO FIREBASE
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyB2ljIwjmbPF1vfCgth4bLd3d7hhLdxKIk",
            authDomain: "lisboago-app.firebaseapp.com",
            databaseURL: "https://lisboago-app-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lisboago-app",
            storageBucket: "lisboago-app.firebasestorage.app",
            messagingSenderId: "467502556237",
            appId: "1:467502556237:web:ff0074a42a664f7efba804"
        };

        let map;
        let driverMarker = null;
        let database = null;

        // Inicializar Firebase
        function initializeFirebase() {
            try {
                // Inicializar Firebase
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                // Testar conex√£o
                database.ref('connection_test').set({
                    timestamp: Date.now(),
                    message: 'Conex√£o estabelecida'
                }).then(() => {
                    document.getElementById('system-status').textContent = '‚úÖ Firebase Conectado!';
                    document.getElementById('system-status').className = 'system-status status-firebase';
                    console.log('‚úÖ Firebase conectado com sucesso!');
                    
                    // Iniciar escuta do motorista
                    setupDriverListener();
                    
                }).catch((error) => {
                    console.error('‚ùå Erro Firebase:', error);
                    document.getElementById('system-status').textContent = '‚ùå Erro no Firebase';
                    // Usar localStorage como fallback
                    setupLocalStorageFallback();
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Firebase:', error);
                setupLocalStorageFallback();
            }
        }

        function setupDriverListener() {
            // Escutar mudan√ßas na posi√ß√£o do motorista
            database.ref('drivers/mega').on('value', (snapshot) => {
                const driverData = snapshot.val();
                
                if (driverData && driverData.isTracking && driverData.position) {
                    // Motorista online
                    updateDriverMarker(driverData.position);
                    document.getElementById('system-status').textContent = 
                        `üöï Motorista Online - ${new Date().toLocaleTimeString()}`;
                    document.getElementById('system-status').className = 'system-status status-online';
                    
                    console.log('üìç Motorista atualizado via Firebase:', driverData.position);
                } else {
                    // Motorista offline
                    removeDriverMarker();
                    document.getElementById('system-status').textContent = 'üîç Procurando motorista...';
                    document.getElementById('system-status').className = 'system-status status-offline';
                }
            }, (error) => {
                console.error('‚ùå Erro no listener Firebase:', error);
                document.getElementById('system-status').textContent = '‚ùå Erro de conex√£o';
                setupLocalStorageFallback();
            });
        }

        function setupLocalStorageFallback() {
            document.getElementById('system-status').textContent = 'üîß Usando Modo Local';
            
            // Verificar a cada 2 segundos
            setInterval(() => {
                try {
                    const driverData = JSON.parse(localStorage.getItem('lisboago_driver') || '{}');
                    if (driverData.isTracking && driverData.position) {
                        updateDriverMarker(driverData.position);
                        document.getElementById('system-status').textContent = 
                            `üöï Motorista (Local) - ${new Date().toLocaleTimeString()}`;
                    } else {
                        removeDriverMarker();
                        document.getElementById('system-status').textContent = 'üîç Aguardando motorista (Local)';
                    }
                } catch (error) {
                    console.log('Erro localStorage:', error);
                }
            }, 2000);
        }

        function updateDriverMarker(position) {
            if (!map) return;
            
            const latLng = new google.maps.LatLng(position.lat, position.lng);
            
            if (driverMarker) {
                driverMarker.setPosition(latLng);
            } else {
                driverMarker = new google.maps.Marker({
                    map: map,
                    position: latLng,
                    title: 'Motorista LisboaGo - Dispon√≠vel',
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/cabs.png',
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });
                
                // Centralizar no motorista
                map.setCenter(latLng);
            }
        }

        function removeDriverMarker() {
            if (driverMarker) {
                driverMarker.setMap(null);
                driverMarker = null;
            }
        }

        function initMap() {
            console.log('üó∫Ô∏è Mapa inicializado');
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 38.7223, lng: -9.1393 },
                zoom: 13
            });

            document.getElementById('driver-area-btn').addEventListener('click', function() {
                const username = prompt('Usu√°rio:');
                const password = prompt('Senha:');
                if (username === 'Mega' && password === '12345') {
                    window.location.href = 'motorista.html';
                } else {
                    alert('Usu√°rio: Mega | Senha: 12345');
                }
            });

            // Inicializar Firebase
            initializeFirebase();
        }

        // Carregar Google Maps
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyBmc6HTJo70N_ueR1qFVgyu74v7FIl7dU4&callback=initMap`;
        script.async = true;
        document.head.appendChild(script);
    </script>
</body>
</html>