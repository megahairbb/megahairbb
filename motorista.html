<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LisboaGo - √Årea do Motorista</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        h1 {
            color: #FFD700;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #FFD700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .status-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .coordinates {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
        
        .coordinate-item {
            margin: 8px 0;
            font-size: 1.1em;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #FFD700;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        
        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }
        
        .btn-back {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            grid-column: 1 / -1;
        }
        
        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }
        
        .status-active {
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #333;
        }
        
        .log-entry {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .log-timestamp {
            color: #888;
        }
        
        .log-message {
            color: #00ff00;
        }
        
        .map-preview {
            height: 200px;
            background: #e9ecef;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöï LisboaGo - √Årea do Motorista</h1>
            <p class="subtitle">Sistema de rastreamento em tempo real para motoristas</p>
        </div>
        
        <div class="dashboard">
            <div class="status-card">
                <h3>Status do Rastreamento</h3>
                <p>Status: <span id="tracking-status" class="status-inactive">INATIVO</span></p>
                
                <div class="coordinates">
                    <div class="coordinate-item">
                        <strong>üìç Latitude:</strong> <span id="current-lat">--</span>
                    </div>
                    <div class="coordinate-item">
                        <strong>üìç Longitude:</strong> <span id="current-lng">--</span>
                    </div>
                    <div class="coordinate-item">
                        <strong>üïí √öltima atualiza√ß√£o:</strong> <span id="last-update">--</span>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="update-count">0</div>
                        <div class="stat-label">Atualiza√ß√µes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accuracy">--</div>
                        <div class="stat-label">Precis√£o (m)</div>
                    </div>
                </div>
            </div>
            
            <div class="status-card">
                <h3>Informa√ß√µes do Sistema</h3>
                <p><strong>üë§ Motorista:</strong> Mega</p>
                <p><strong>üöó Ve√≠culo:</strong> LisboaGo Taxi</p>
                <p><strong>üì± Status:</strong> <span id="connection-status">Conectado</span></p>
                
                <div class="map-preview" id="map-preview">
                    Visualiza√ß√£o do mapa (em breve)
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-start" id="start-tracking">
                üöÄ INICIAR RASTREAMENTO
            </button>
            
            <button class="btn btn-stop" id="stop-tracking" disabled>
                üõë PARAR RASTREAMENTO
            </button>
            
            <button class="btn btn-back" onclick="window.location.href='index.html'">
                ‚Ü© VOLTAR PARA O MAPA PRINCIPAL
            </button>
        </div>
        
        <div class="log-container" id="log-container">
            <div class="log-entry">
                <span class="log-timestamp">[Sistema]</span>
                <span class="log-message">√Årea do motorista inicializada. Aguardando comando...</span>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // SISTEMA DE RASTREAMENTO DO MOTORISTA
        // =============================================
        
        // Vari√°veis do motorista
        let trackingInterval = null;
        let isTracking = false;
        let watchId = null;
        let currentPosition = null;
        let updateCount = 0;
        let startTime = null;

        // Elementos da interface
        const startBtn = document.getElementById('start-tracking');
        const stopBtn = document.getElementById('stop-tracking');
        const statusElement = document.getElementById('tracking-status');
        const latElement = document.getElementById('current-lat');
        const lngElement = document.getElementById('current-lng');
        const updateElement = document.getElementById('last-update');
        const updateCountElement = document.getElementById('update-count');
        const accuracyElement = document.getElementById('accuracy');
        const connectionElement = document.getElementById('connection-status');
        const logContainer = document.getElementById('log-container');

        // Fun√ß√£o para adicionar log com timestamp
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let emoji = '‚ÑπÔ∏è';
            if (type === 'success') emoji = '‚úÖ';
            if (type === 'error') emoji = '‚ùå';
            if (type === 'warning') emoji = '‚ö†Ô∏è';
            if (type === 'gps') emoji = 'üìç';
            
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-message">${emoji} ${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Fun√ß√£o para atualizar a posi√ß√£o no localStorage
        function updateDriverPosition(position) {
            const driverData = {
                isTracking: true,
                position: {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                },
                timestamp: Date.now(),
                updateCount: updateCount,
                accuracy: position.coords.accuracy,
                heading: position.coords.heading,
                speed: position.coords.speed
            };
            
            // Salvar no localStorage
            localStorage.setItem('lisboago_driver_data', JSON.stringify(driverData));
            
            // Disparar evento customizado para for√ßar atualiza√ß√£o
            window.dispatchEvent(new Event('storage'));
            
            // Atualizar interface
            currentPosition = position;
            latElement.textContent = position.coords.latitude.toFixed(6);
            lngElement.textContent = position.coords.longitude.toFixed(6);
            updateElement.textContent = new Date().toLocaleTimeString();
            accuracyElement.textContent = Math.round(position.coords.accuracy);
            
            updateCount++;
            updateCountElement.textContent = updateCount;
            
            // Log apenas a cada 5 atualiza√ß√µes para n√£o poluir
            if (updateCount % 5 === 0) {
                addLog(`Posi√ß√£o ${updateCount}: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`, 'gps');
            }
        }

        // Fun√ß√£o para simular movimento (para testes)
        function simulateMovement() {
            if (!currentPosition || !isTracking) return;
            
            // Simular pequenas varia√ß√µes na posi√ß√£o
            const variation = 0.0001;
            const newPosition = {
                coords: {
                    latitude: currentPosition.coords.latitude + (Math.random() - 0.5) * variation,
                    longitude: currentPosition.coords.longitude + (Math.random() - 0.5) * variation,
                    accuracy: currentPosition.coords.accuracy,
                    heading: currentPosition.coords.heading,
                    speed: currentPosition.coords.speed
                },
                timestamp: Date.now()
            };
            
            updateDriverPosition(newPosition);
        }

        // Fun√ß√£o para iniciar rastreamento
        function startTracking() {
            if (isTracking) return;
            
            addLog('INICIANDO SISTEMA DE RASTREAMENTO...', 'warning');
            
            // Resetar contadores
            updateCount = 0;
            startTime = Date.now();
            updateCountElement.textContent = '0';
            
            if (navigator.geolocation) {
                // Configura√ß√µes de alta precis√£o
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };
                
                addLog('Configurando geolocaliza√ß√£o de alta precis√£o...', 'info');
                
                // Primeira posi√ß√£o imediata
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        updateDriverPosition(position);
                        addLog('Primeira posi√ß√£o obtida com sucesso!', 'success');
                    },
                    function(error) {
                        addLog(`Erro na primeira posi√ß√£o: ${error.message}`, 'error');
                    },
                    options
                );
                
                // Iniciar watchPosition para atualiza√ß√µes cont√≠nuas
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        updateDriverPosition(position);
                    },
                    function(error) {
                        addLog(`Erro de geolocaliza√ß√£o: ${error.message}`, 'error');
                    },
                    options
                );
                
                // Sistema de backup com setInterval (1 segundo)
                trackingInterval = setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        updateDriverPosition,
                        function(error) {
                            addLog(`Erro de geolocaliza√ß√£o (backup): ${error.message}`, 'error');
                        },
                        options
                    );
                }, 1000);
                
                // Simula√ß√£o de movimento (apenas para teste/demo)
                const simulationInterval = setInterval(simulateMovement, 2000);
                
                // Atualizar interface
                isTracking = true;
                statusElement.textContent = 'ATIVO';
                statusElement.className = 'status-active';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                connectionElement.textContent = 'Transmitindo';
                
                addLog('‚úÖ RASTREAMENTO ATIVO - Enviando posi√ß√£o a cada 1 segundo', 'success');
                addLog('O cliente pode agora ver sua localiza√ß√£o em tempo real no mapa', 'info');
                
            } else {
                addLog('‚ùå Geolocaliza√ß√£o n√£o suportada pelo navegador', 'error');
                alert('Seu navegador n√£o suporta geolocaliza√ß√£o. Use um navegador moderno.');
            }
        }

        // Fun√ß√£o para parar rastreamento
        function stopTracking() {
            if (!isTracking) return;
            
            addLog('PARANDO SISTEMA DE RASTREAMENTO...', 'warning');
            
            // Parar watchPosition
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Parar intervalos
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            // Atualizar localStorage para indicar que parou
            localStorage.setItem('lisboago_driver_data', JSON.stringify({
                isTracking: false,
                timestamp: Date.now(),
                message: 'Rastreamento parado pelo motorista'
            }));
            
            // Disparar evento para atualizar o cliente
            window.dispatchEvent(new Event('storage'));
            
            // Atualizar interface
            isTracking = false;
            statusElement.textContent = 'INATIVO';
            statusElement.className = 'status-inactive';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            connectionElement.textContent = 'Desconectado';
            
            // Resetar displays
            latElement.textContent = '--';
            lngElement.textContent = '--';
            updateElement.textContent = '--';
            accuracyElement.textContent = '--';
            
            addLog('‚úÖ RASTREAMENTO PARADO - Cliente n√£o ver√° mais sua localiza√ß√£o', 'success');
        }

        // Fun√ß√£o para verificar status atual ao carregar
        function checkCurrentStatus() {
            const existingData = localStorage.getItem('lisboago_driver_data');
            if (existingData) {
                try {
                    const data = JSON.parse(existingData);
                    if (data.isTracking) {
                        addLog('‚ö†Ô∏è Rastreamento anterior detectado. Reinicie o rastreamento.', 'warning');
                    }
                } catch (e) {
                    addLog('Erro ao ler dados anteriores do rastreamento', 'error');
                }
            }
        }

        // Event listeners
        startBtn.addEventListener('click', startTracking);
        stopBtn.addEventListener('click', stopTracking);

        // Verificar status ao carregar a p√°gina
        window.addEventListener('load', function() {
            addLog('Sistema do motorista carregado com sucesso', 'success');
            addLog('Pronto para iniciar rastreamento em tempo real', 'info');
            checkCurrentStatus();
        });

        // Monitorar conex√£o
        window.addEventListener('online', function() {
            connectionElement.textContent = 'Conectado';
            addLog('Conex√£o restaurada', 'success');
        });

        window.addEventListener('offline', function() {
            connectionElement.textContent = 'Offline';
            addLog('Conex√£o perdida - as atualiza√ß√µes podem parar', 'error');
        });

        // Prevenir que a p√°gina feche acidentalmente durante o rastreamento
        window.addEventListener('beforeunload', function(e) {
            if (isTracking) {
                e.preventDefault();
                e.returnValue = 'O rastreamento est√° ativo. Tem certeza que deseja sair?';
                return 'O rastreamento est√° ativo. Tem certeza que deseja sair?';
            }
        });

        // Sistema de heartbeat para manter o rastreamento ativo
        setInterval(() => {
            if (isTracking && currentPosition) {
                // Atualizar timestamp para manter dados frescos
                const driverData = {
                    isTracking: true,
                    position: currentPosition.coords,
                    timestamp: Date.now(),
                    updateCount: updateCount,
                    heartbeat: true
                };
                localStorage.setItem('lisboago_driver_data', JSON.stringify(driverData));
            }
        }, 30000); // A cada 30 segundos

        // Inicializa√ß√£o completa
        addLog('=========================================', 'info');
        addLog('SISTEMA LISBOAGO MOTORISTA INICIALIZADO', 'success');
        addLog('Vers√£o 2.0 - Rastreamento em Tempo Real', 'info');
        addLog('=========================================', 'info');
    </script>
</body>
</html>